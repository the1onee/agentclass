{% extends 'base.html' %}
{% load static %}
{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="card shadow mb-4 border-left-primary">
        <div class="card-header py-3 d-flex justify-content-between align-items-center bg-gradient-primary text-white">
            <h6 class="mb-0 font-weight-bold text-primary">{{ title }}</h6>
            <a href="{% url 'port:trip_list' %}" class="btn btn-light btn-sm">
                <i class="fas fa-arrow-right ml-2"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
            </a>
        </div>
        <div class="card-body">
            <form method="post" id="tripForm">
                {% csrf_token %}
                
                <!-- Ø±Ø³Ø§Ù„Ø© ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
                <div class="alert alert-info alert-dismissible fade show mb-4" role="alert">
                    <i class="fas fa-info-circle ml-2"></i>
                    <strong>ØªØ¹Ù„ÙŠÙ…Ø§Øª:</strong> Ù‚Ù… Ø¨Ø§Ø®ØªÙŠØ§Ø± Ø¥Ø°Ù† Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… Ù‚Ù… Ø¨ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§Ù„Ø´Ø§Ø­Ù†Ø© Ù„ÙƒÙ„ Ø­Ø§ÙˆÙŠØ©
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <!-- Ù…Ø¤Ø´Ø± Ø§Ù„ØªÙ‚Ø¯Ù… -->
                <div class="progress-tracker mb-4">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" id="progressBar"></div>
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                        <span class="step-indicator active" id="step1">
                            <i class="fas fa-info-circle"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø©
                        </span>
                        <span class="step-indicator" id="step2">
                            <i class="fas fa-file-invoice"></i> Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¥Ø°Ù†
                        </span>
                        <span class="step-indicator" id="step3">
                            <i class="fas fa-shipping-fast"></i> ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª
                        </span>
                        <span class="step-indicator" id="step4">
                            <i class="fas fa-check-circle"></i> Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ§Ù„Ø­ÙØ¸
                        </span>
                    </div>
                </div>

                <div class="row">
                    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø© -->
                    <div class="col-md-6">
                        <div class="card mb-4 border-left-info shadow-sm scientific-card">
                            <div class="card-header bg-gradient-info text-white py-3">
                                <h6 class="mb-0 font-weight-bold text-primary">
                                    <i class="fas fa-route ml-2"></i>
                                    Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø©
                                </h6>
                            </div>
                            <div class="card-body position-relative">
                                <!-- Ø®Ù„ÙÙŠØ© Ø¹Ù„Ù…ÙŠØ© -->
                                <div class="scientific-bg"></div>
                                
                                {% for field in form.visible_fields %}
                                    {% if field.name not in 'containers,delivery_orders' %}
                                    <div class="form-group">
                                        <label for="{{ field.id_for_label }}">
                                            <i class="fas fa-file-alt ml-1"></i> {{ field.label }}
                                        </label>
                                        {{ field }}
                                        {% if field.errors %}
                                            <div class="text-danger">
                                                {{ field.errors }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                {% endfor %}
                                {% for hidden in form.hidden_fields %}
                                    {{ hidden }}
                                {% endfor %}
                                
                                <!-- Ù…Ø¤Ø´Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
                                <div class="data-indicator">
                                    <div class="data-pulse"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ø§Ø®ØªÙŠØ§Ø± Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„ØªØ³Ù„ÙŠÙ… -->
                    <div class="col-md-6">
                        <div class="card mb-4 border-left-warning shadow-sm scientific-card">
                            <div class="card-header bg-gradient-warning text-white py-3">
                                <h6 class="mb-0 font-weight-bold text-primary">
                                    <i class="fas fa-file-invoice ml-2"></i>
                                    Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„ØªØ³Ù„ÙŠÙ…
                                </h6>
                            </div>
                            <div class="card-body position-relative">
                                <!-- Ø®Ù„ÙÙŠØ© Ø¹Ù„Ù…ÙŠØ© -->
                                <div class="scientific-bg"></div>
                                
                                <div class="form-group">
                                    <label for="delivery_order_select">
                                        <i class="fas fa-search ml-1"></i> Ø§Ø®ØªØ± Ø¥Ø°Ù† Ø§Ù„ØªØ³Ù„ÙŠÙ…
                                    </label>
                                    <select id="delivery_order_select" name="delivery_orders" class="form-control">
                                        <option value="">-- Ø§Ø®ØªØ± Ø¥Ø°Ù† Ø§Ù„ØªØ³Ù„ÙŠÙ… --</option>
                                        {% for order in delivery_orders %}
                                        <option value="{{ order.id }}">{{ order.order_number }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div id="selectedOrderInfo" class="mt-3" style="display: none;">
                                    <div class="alert alert-warning position-relative">
                                        <h6 id="orderTitle" class="mb-2 font-weight-bold"></h6>
                                        <p id="orderDate" class="mb-0"></p>
                                        <span class="position-absolute" style="top: 10px; left: 10px;">
                                            <i class="fas fa-file-invoice fa-2x text-warning-50 opacity-50"></i>
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Ù…Ø¤Ø´Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
                                <div class="data-indicator">
                                    <div class="data-pulse"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª -->
                <div class="card mb-4 border-left-success shadow-sm scientific-card" id="containersCard" style="display: none;">
                    <div class="card-header bg-gradient-success text-white py-3 d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 font-weight-bold text-primary">
                            <i class="fas fa-shipping-fast ml-2"></i>
                            Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
                        </h6>
                        <div class="d-flex align-items-center">
                            <div class="data-counter mr-2">
                                <span id="containersCount">0</span>
                                <div class="counter-label">Ø­Ø§ÙˆÙŠØ©</div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body position-relative">
                        <!-- Ø®Ù„ÙÙŠØ© Ø¹Ù„Ù…ÙŠØ© -->
                        <div class="scientific-bg"></div>
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover" id="containersTable" style="background-color: #f8f9fa;">
                                <thead class="thead-dark">
                                    <tr>
                                        <th style="color: #ffffff; background-color: #343a40;"><i class="fas fa-hashtag ml-1"></i> Ø±Ù‚Ù… Ø§Ù„Ø­Ø§ÙˆÙŠØ©</th>
                                        <th style="color: #ffffff; background-color: #343a40;"><i class="fas fa-box ml-1"></i> Ø§Ù„Ù†ÙˆØ¹</th>
                                        <th style="color: #ffffff; background-color: #343a40;"><i class="fas fa-weight-hanging ml-1"></i> Ø§Ù„ÙˆØ²Ù†</th>
                                        <th style="color: #ffffff; background-color: #343a40;"><i class="fas fa-user-tie ml-1"></i> Ø§Ù„Ø³Ø§Ø¦Ù‚</th>
                                        <th style="color: #ffffff; background-color: #343a40;"><i class="fas fa-truck ml-1"></i> Ø§Ù„Ø´Ø§Ø­Ù†Ø©</th>
                                    </tr>
                                </thead>
                                <tbody id="containersTableBody">
                                    <!-- Ø³ØªØªÙ… Ø¥Ø¶Ø§ÙØ© ØµÙÙˆÙ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª Ù‡Ù†Ø§ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Ø²Ø± Ø§Ù„Ø­ÙØ¸ -->
                <div class="form-group text-center">
                    <input type="hidden" name="containers" id="containersData">
                    <button type="submit" id="saveButton" class="btn btn-primary btn-lg px-5 shadow animate-btn">
                        <i class="fas fa-save ml-2"></i> Ø­ÙØ¸ Ø§Ù„Ø±Ø­Ù„Ø©
                        <span class="save-indicator"></span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
<div class="loading-overlay">
    <div class="spinner-wrapper">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
        </div>
        <div class="spinner-text mt-2">Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø­ÙŠÙˆÙŠØ© */
    .animate-btn {
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .animate-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
    }
    
    .animate-btn:after {
        content: "";
        display: block;
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        pointer-events: none;
        background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
        background-repeat: no-repeat;
        background-position: 50%;
        transform: scale(10, 10);
        opacity: 0;
        transition: transform .5s, opacity 1s;
    }
    
    .animate-btn:active:after {
        transform: scale(0, 0);
        opacity: .3;
        transition: 0s;
    }
    
    .card {
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0,0,0,0.1) !important;
    }
    
    /* ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
    #containersTable tbody tr {
        transition: background-color 0.2s ease;
    }
    
    #containersTable tbody tr:hover {
        background-color: rgba(0,123,255,0.05);
    }
    
    /* Ø´Ø±ÙŠØ· ØªÙ‚Ø¯Ù… Ù„Ù„ØªØ­Ù…ÙŠÙ„ */
    .loading-bar {
        height: 3px;
        width: 100%;
        position: fixed;
        top: 0;
        left: 0;
        background-color: #007bff;
        display: none;
        z-index: 9999;
        animation: loading-animation 2s infinite;
    }
    
    @keyframes loading-animation {
        0% { width: 0%; }
        50% { width: 70%; }
        100% { width: 100%; }
    }
    
    /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø²Ø± Ø§Ù„ÙØ¹Ø§Ù„ */
    .btn-pulse {
        animation: pulse-animation 1.5s infinite;
    }
    
    @keyframes pulse-animation {
        0% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(0, 123, 255, 0); }
        100% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0); }
    }
    
    /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØµÙ Ø§Ù„Ù…Ø¶Ø§Ù Ø­Ø¯ÙŠØ«Ù‹Ø§ */
    .new-row {
        animation: highlight 1.5s ease-out;
    }
    
    @keyframes highlight {
        0% { background-color: #d4edda; }
        100% { background-color: transparent; }
    }
    
    /* Ø¥Ø¶Ø§ÙØ§Øª Ø¹Ù„Ù…ÙŠØ© */
    .scientific-card {
        overflow: hidden;
    }
    
    .scientific-bg {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        opacity: 0.03;
        background-image: 
            linear-gradient(30deg, #000 12%, transparent 12.5%, transparent 87%, #000 87.5%, #000),
            linear-gradient(150deg, #000 12%, transparent 12.5%, transparent 87%, #000 87.5%, #000),
            linear-gradient(30deg, #000 12%, transparent 12.5%, transparent 87%, #000 87.5%, #000),
            linear-gradient(150deg, #000 12%, transparent 12.5%, transparent 87%, #000 87.5%, #000),
            linear-gradient(60deg, #77f 25%, transparent 25.5%, transparent 75%, #77f 75%, #77f);
        background-size: 80px 140px;
        pointer-events: none;
    }
    
    /* Ù…Ø¤Ø´Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
    .data-indicator {
        position: absolute;
        bottom: 10px;
        right: 10px;
        width: 15px;
        height: 15px;
        border-radius: 50%;
        background-color: rgba(0, 123, 255, 0.1);
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    .data-pulse {
        width: 7px;
        height: 7px;
        border-radius: 50%;
        background-color: #007bff;
        animation: data-pulse 1.5s infinite;
    }
    
    @keyframes data-pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.5); opacity: 0.5; }
        100% { transform: scale(1); opacity: 1; }
    }
    
    /* Ù…Ø¤Ø´Ø± Ø§Ù„ØªÙ‚Ø¯Ù… */
    .progress-tracker {
        margin-bottom: 20px;
    }
    
    .progress {
        height: 8px;
        border-radius: 4px;
        overflow: hidden;
        background-color: #e9ecef;
    }
    
    .step-indicator {
        font-size: 0.8rem;
        color: #6c757d;
        position: relative;
        padding-top: 10px;
        transition: all 0.3s ease;
    }
    
    .step-indicator.active {
        color: #007bff;
        font-weight: bold;
    }
    
    .step-indicator.completed {
        color: #28a745;
    }
    
    .step-indicator:before {
        content: '';
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background-color: #e9ecef;
        border: 2px solid #fff;
        z-index: 1;
    }
    
    .step-indicator.active:before {
        background-color: #007bff;
    }
    
    .step-indicator.completed:before {
        background-color: #28a745;
    }
    
    /* Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
    .data-counter {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .data-counter #containersCount {
        font-weight: bold;
        font-size: 16px;
        line-height: 1;
        color: #28a745;
    }
    
    .counter-label {
        font-size: 8px;
        color: #6c757d;
    }
    
    /* Ù…Ø¤Ø´Ø± Ø§Ù„Ø­ÙØ¸ */
    .save-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #fff;
        margin-right: 5px;
        position: relative;
        top: -1px;
    }
    
    /* Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        backdrop-filter: blur(5px);
    }
    
    .spinner-wrapper {
        text-align: center;
    }
    
    .spinner-text {
        color: #007bff;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙŠØ· Ø§Ù„ØªØ­Ù…ÙŠÙ„
        $('body').prepend('<div class="loading-bar"></div>');
        
        // ØªØ­Ø³ÙŠÙ† ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        $('.form-control').addClass('shadow-sm');
        
        // ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        $('select').not('.driver-select, .truck-select').select2({
            width: '100%',
            dir: 'rtl',
            placeholder: 'Ø§Ø®ØªØ±...'
        });
        
        // ØªÙ†Ø³ÙŠÙ‚ Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®
        if($.fn.flatpickr) {
            $('input[type="datetime-local"]').flatpickr({
                enableTime: true,
                dateFormat: "Y-m-d H:i",
                locale: "ar"
            });
        }
        
        // ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø± Ø§Ù„ØªÙ‚Ø¯Ù…
        function updateProgress(step) {
            // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
            let percentage = 0;
            switch(step) {
                case 1: percentage = 25; break;
                case 2: percentage = 50; break;
                case 3: percentage = 75; break;
                case 4: percentage = 100; break;
            }
            
            $('#progressBar').css('width', percentage + '%');
            
            // ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø®Ø·ÙˆØ§Øª
            $('.step-indicator').removeClass('active completed');
            for (let i = 1; i <= 4; i++) {
                if (i < step) {
                    $('#step' + i).addClass('completed');
                } else if (i === step) {
                    $('#step' + i).addClass('active');
                }
            }
        }
        
        // ØªÙ‡ÙŠØ¦Ø© Ù…Ø¤Ø´Ø± Ø§Ù„ØªÙ‚Ø¯Ù…
        updateProgress(1);
        
        // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø«Ø§Ù†ÙŠØ© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø£ÙŠ Ø­Ù‚Ù„ ÙÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø©
        $('.form-control').not('#delivery_order_select, .driver-select, .truck-select').change(function() {
            updateProgress(2);
        });

        // Ø­Ø¯Ø« Ø§Ø®ØªÙŠØ§Ø± Ø¥Ø°Ù† Ø§Ù„ØªØ³Ù„ÙŠÙ…
        $('#delivery_order_select').change(function() {
            const permitId = $(this).val();
            console.log('ğŸ” ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø¥Ø°Ù† Ø§Ù„ØªØ³Ù„ÙŠÙ…:', permitId);
            console.log('ğŸ” Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', typeof permitId);
            console.log('ğŸ” Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø­Ø¯Ø¯:', this);
            console.log('ğŸ” Ø¬Ù…ÙŠØ¹ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¥Ø°Ù†:', $('#delivery_order_select option').map(function() { return { value: this.value, text: this.text }; }).get());
            
            if (permitId) {
                console.log('âœ… Ø§Ù„Ù…Ø¹Ø±Ù ØµØ§Ù„Ø­ØŒ Ø¨Ø¯Ø¡ Ø·Ù„Ø¨ AJAX...');
                // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø±ÙŠØ· Ø§Ù„ØªØ­Ù…ÙŠÙ„
                $('.loading-bar').show();
                
                // ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø± Ø§Ù„ØªÙ‚Ø¯Ù…
                updateProgress(3);
                
                // Ø·Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø°Ù† ÙˆØ§Ù„Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
                                                                $.ajax({
                            url: `/get_permit_containers/${permitId}/`,
                            type: 'GET',
                            dataType: 'json',
                            headers: {
                                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                    beforeSend: function() {
                        // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
                        $('.loading-overlay').css('display', 'flex');
                    },
                    success: function(response) {
                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
                        if (!response || !response.delivery_order || !response.containers) {
                            throw new Error('Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…');
                        }

                        // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥Ø°Ù†
                        $('#orderTitle').html(`<i class="fas fa-file-invoice ml-1"></i> Ø¥Ø°Ù† Ø§Ù„ØªØ³Ù„ÙŠÙ…: ${response.delivery_order.number}`);
                        $('#orderDate').html(`<i class="far fa-calendar-alt ml-1"></i> ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±: ${response.delivery_order.date}`);
                        $('#selectedOrderInfo').fadeIn(300);

                        // Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
                        $('#containersTableBody').empty();
                        
                        // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª
                        $('#containersCount').text(response.containers.length);
                        
                        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙÙˆÙ Ø¨ØªØ£Ø«ÙŠØ± Ù…ØªØªØ§Ù„ÙŠ
                        if (response.containers.length > 0) {
                            response.containers.forEach(function(container, index) {
                                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§ÙˆÙŠØ©
                                if (!container.id || !container.number) {
                                    console.error('Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø§ÙˆÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­Ø©:', container);
                                    return;
                                }

                                // ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¶Ø§ÙØ© Ø³Ù…Ø© data-id Ù„ÙƒÙ„ ØµÙ
                                const row = `
                                    <tr data-id="${container.id}" class="container-row">
                                        <td>
                                            <span class="badge badge-success font-weight-bold p-2" style="color:rgb(17, 0, 255);">${container.number}</span>
                                            <input type="hidden" name="container_ids[]" value="${container.id}">
                                        </td>
                                        <td>${container.type || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                                        <td>${container.weight || 'N/A'}</td>
                                        <td>ØªÙ„Ù‚Ø§Ø¦ÙŠ</td>
                                        <td>ØªÙ„Ù‚Ø§Ø¦ÙŠ</td>
                                    </tr>
                                `;
                                $('#containersTableBody').append(row);
                            });

                            // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„Ø­ÙØ¸ Ù…Ø¹ ØªØ£Ø«ÙŠØ± Ù†Ø¨Ø¶
                            $('#saveButton').addClass('btn-pulse');
                            
                            // Ø¥Ø¸Ù‡Ø§Ø± Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª
                            $('#containersCard').fadeIn(400);
                            
                            // ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø± Ø§Ù„ØªÙ‚Ø¯Ù… Ù„Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©
                            updateProgress(4);
                            
                            // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
                            $('.loading-overlay').hide();
                        } else {
                            // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø­Ø§ÙˆÙŠØ§Øª
                            $('#containersTableBody').html(`
                                <tr>
                                    <td colspan="5" class="text-center py-4">
                                        <div class="alert alert-warning mb-0">
                                            <i class="fas fa-exclamation-triangle ml-2"></i>
                                            Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§ÙˆÙŠØ§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø°Ù†
                                        </div>
                                    </td>
                                </tr>
                            `);
                            $('#containersCard').fadeIn(400);
                            $('#saveButton').removeClass('btn-pulse');
                            
                            // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
                            $('.loading-overlay').hide();
                        }
                    },
                    error: function(xhr, status, error) {
                        // Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªØ­Ù…ÙŠÙ„
                        $('.loading-bar').hide();
                        $('.loading-overlay').hide();
                        
                        // Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…ÙØµÙ„Ø© Ø¹Ù† Ø§Ù„Ø®Ø·Ø£
                        console.log('===== ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£ =====');
                        console.log('Status:', status);
                        console.log('Error:', error);
                        console.log('Response Status:', xhr.status);
                        console.log('Response Text:', xhr.responseText);
                        console.log('Request URL:', `/get_permit_containers/${permitId}/`);
                        console.log('CSRF Token:', $('input[name="csrfmiddlewaretoken"]').val());
                        console.log('=========================');
                        
                        // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø®Ø·Ø£
                        let errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø°Ù† ÙˆØ§Ù„Ø­Ø§ÙˆÙŠØ§Øª';
                        let details = '';
                        let statusCode = xhr.status || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                        
                        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø±Ù…Ø² Ø§Ù„Ø­Ø§Ù„Ø©
                        let statusText = '';
                        switch(xhr.status) {
                            case 404:
                                statusText = 'Ø§Ù„Ù…ÙˆØ±Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯';
                                errorMessage = 'Ø§Ù„Ø¥Ø°Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯';
                                break;
                            case 500:
                                statusText = 'Ø®Ø·Ø£ Ø¯Ø§Ø®Ù„ÙŠ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…';
                                break;
                            case 403:
                                statusText = 'Ù…Ù…Ù†ÙˆØ¹ Ø§Ù„ÙˆØµÙˆÙ„';
                                errorMessage = 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø°Ù†';
                                break;
                            case 0:
                                statusText = 'Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…';
                                errorMessage = 'ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…';
                                break;
                            default:
                                statusText = xhr.statusText || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                        }
                        
                        try {
                            const response = JSON.parse(xhr.responseText);
                            if (response.error) {
                                errorMessage = response.error;
                            }
                            if (response.details) {
                                details = '\nØ§Ù„ØªÙØ§ØµÙŠÙ„: ' + response.details;
                            }
                            if (response.debug_info) {
                                details += '\nÙ…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­: ' + response.debug_info;
                            }
                        } catch (e) {
                            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø®Ø§Ø¯Ù…:', e);
                            details = `\nØ±Ù…Ø² Ø§Ù„Ø­Ø§Ù„Ø©: ${statusCode} - ${statusText}`;
                            if (xhr.responseText && xhr.responseText.length < 500) {
                                details += '\nØ§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø®Ø§Ø¯Ù…: ' + xhr.responseText;
                            }
                        }
                        
                        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
                        if (typeof Swal !== 'undefined') {
                            Swal.fire({
                                icon: 'error',
                                title: 'Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
                                html: `<div style="text-align: right;">
                                    <p><strong>Ø§Ù„Ø®Ø·Ø£:</strong> ${errorMessage}</p>
                                    <p><strong>Ø±Ù…Ø² Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${statusCode}</p>
                                    <p><strong>Ø§Ù„ÙˆØµÙ:</strong> ${statusText}</p>
                                    ${details ? `<p><strong>Ø§Ù„ØªÙØ§ØµÙŠÙ„:</strong> ${details.replace(/\n/g, '<br>')}</p>` : ''}
                                </div>`,
                                confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹',
                                width: '600px'
                            });
                        } else {
                            alert(`${errorMessage}\nØ±Ù…Ø² Ø§Ù„Ø­Ø§Ù„Ø©: ${statusCode}\n${statusText}${details}`);
                        }
                        
                        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', {
                            status: status,
                            error: error,
                            statusCode: xhr.status,
                            statusText: xhr.statusText,
                            response: xhr.responseText,
                            url: `/get_permit_containers/${permitId}/`
                        });
                    },
                    complete: function() {
                        // Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
                        $('.loading-bar').hide();
                    }
                });
            } else {
                // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥Ø°Ù† ÙˆØ¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª Ø¹Ù†Ø¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
                $('#selectedOrderInfo').fadeOut(300);
                $('#containersCard').fadeOut(300);
                $('#saveButton').removeClass('btn-pulse');
                
                // Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø¤Ø´Ø± Ø§Ù„ØªÙ‚Ø¯Ù… Ù„Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø«Ø§Ù†ÙŠØ©
                updateProgress(2);
            }
        });
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        $('#tripForm').submit(function(e) {
            e.preventDefault();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† CSRF token
            const csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
            if (!csrfToken) {
                console.error('CSRF token ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'error',
                        title: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø£Ù…Ø§Ù†',
                        text: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù…Ø§Ù†. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.',
                        confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
                    });
                } else {
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù…Ø§Ù†. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                }
                return false;
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø¥Ø°Ù† ØªØ³Ù„ÙŠÙ…
            const deliveryOrderId = $('#delivery_order_select').val();
            if (!deliveryOrderId) {
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'warning',
                        title: 'ØªÙ†Ø¨ÙŠÙ‡',
                        text: 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¥Ø°Ù† ØªØ³Ù„ÙŠÙ… Ø£ÙˆÙ„Ø§Ù‹',
                        confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
                    });
                } else {
                    alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¥Ø°Ù† ØªØ³Ù„ÙŠÙ… Ø£ÙˆÙ„Ø§Ù‹');
                }
                return false;
            }
            
            // Ø¬Ù…Ø¹ Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª
            const containers = [];
            $('#containersTableBody tr.container-row').each(function() {
                const containerId = $(this).attr('data-id');
                if (containerId) {
                    containers.push({
                        id: containerId,
                        // ØªØ¹ÙŠÙŠÙ† Ù‚ÙŠÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§Ù„Ø´Ø§Ø­Ù†Ø©
                        driver: "auto",
                        truck: "auto"
                    });
                }
            });
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø­Ø§ÙˆÙŠØ§Øª
            if (containers.length === 0) {
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'warning',
                        title: 'ØªÙ†Ø¨ÙŠÙ‡',
                        text: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§ÙˆÙŠØ§Øª Ù„Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø­Ù„Ø©',
                        confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
                    });
                } else {
                    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§ÙˆÙŠØ§Øª Ù„Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø­Ù„Ø©');
                }
                return false;
            }

            // Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª Ù„Ù„Ù†Ù…ÙˆØ°Ø¬
            $('#containersData').val(JSON.stringify(containers));
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø±Ù Ø¥Ø°Ù† Ø§Ù„ØªØ³Ù„ÙŠÙ… ÙƒØ­Ù‚Ù„ Ù…Ø®ÙÙŠ
            if (!$('#selected_delivery_order').length) {
                $('<input>').attr({
                    type: 'hidden',
                    id: 'selected_delivery_order',
                    name: 'delivery_order',
                    value: deliveryOrderId
                }).appendTo('#tripForm');
            } else {
                $('#selected_delivery_order').val(deliveryOrderId);
            }
            
            // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ­ÙŠØ­
            console.log('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬:', {
                delivery_order: deliveryOrderId,
                containers: containers
            });
            
            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¯ÙˆÙ† ØªØ£ÙƒÙŠØ¯
            const form = $('#tripForm')[0];
            const formData = new FormData(form);
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„ØªØµØ­ÙŠØ­
            formData.append('debug', 'true');
            formData.append('auto_assign', 'true'); // Ø¥Ø´Ø§Ø±Ø© Ù„Ù„Ø®Ø§Ø¯Ù… Ø¨ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙˆØ§Ù„Ø´Ø§Ø­Ù†Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø±Ù Ø¥Ø°Ù† Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø¨Ø´ÙƒÙ„ ØµØ±ÙŠØ­
            formData.append('delivery_order_id', deliveryOrderId);
            
            $.ajax({
                url: form.action || window.location.href,
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    'X-CSRFToken': csrfToken
                },
                beforeSend: function() {
                    // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
                    $('.loading-overlay').css('display', 'flex');
                    $('#saveButton').prop('disabled', true).html('<i class="fas fa-spinner fa-spin ml-2"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...');
                },
                success: function(response) {
                    console.log('Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­:', response);
                    
                    if (response.success) {
                        // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø­Ù„Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø©
                        window.location.href = '/trips/';
                    } else {
                        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù…ÙØµÙ„Ø©
                        let errorMessage = response.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø±Ø­Ù„Ø©';
                        if (response.details) {
                            errorMessage += '\nØ§Ù„ØªÙØ§ØµÙŠÙ„: ' + response.details;
                        }
                        
                        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©:', response);
                        
                        if (typeof Swal !== 'undefined') {
                            Swal.fire({
                                icon: 'error',
                                title: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸',
                                text: errorMessage,
                                confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
                            });
                        } else {
                            alert(errorMessage);
                        }
                        
                        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„Ø­ÙØ¸
                        $('#saveButton').prop('disabled', false).html('<i class="fas fa-save ml-2"></i> Ø­ÙØ¸ Ø§Ù„Ø±Ø­Ù„Ø©');
                    }
                },
                error: function(xhr, status, error) {
                    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù…ÙØµÙ„Ø©
                    let errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø±Ø­Ù„Ø©';
                    
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø·Ù„Ø¨:', {
                        status: status,
                        error: error,
                        response: xhr.responseText
                    });
                    
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (response.error) {
                            errorMessage = response.error;
                        }
                        if (response.details) {
                            errorMessage += '\nØ§Ù„ØªÙØ§ØµÙŠÙ„: ' + response.details;
                        }
                    } catch (e) {
                        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø®Ø§Ø¯Ù…:', e);
                    }
                    
                    if (typeof Swal !== 'undefined') {
                        Swal.fire({
                            icon: 'error',
                            title: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸',
                            text: errorMessage,
                            confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
                        });
                    } else {
                        alert(errorMessage);
                    }
                    
                    // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„Ø­ÙØ¸
                    $('#saveButton').prop('disabled', false).html('<i class="fas fa-save ml-2"></i> Ø­ÙØ¸ Ø§Ù„Ø±Ø­Ù„Ø©');
                },
                complete: function() {
                    // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
                    $('.loading-overlay').hide();
                }
            });
            
            return false;
        });
        
        // ØªÙ†ÙÙŠØ° Ø±Ø³ÙˆÙ… Ù…ØªØ­Ø±ÙƒØ© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        setTimeout(function() {
            $('.card').each(function(index) {
                $(this).css({
                    'opacity': 0,
                    'transform': 'translateY(20px)'
                }).delay(index * 100).animate({
                    'opacity': 1,
                    'transform': 'translateY(0)'
                }, 500);
            });
        }, 100);
        
        // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ±Ø§Øª ØªÙØ§Ø¹Ù„ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ©
        $('.form-control').focus(function() {
            $(this).closest('.form-group').addClass('highlight-group');
        }).blur(function() {
            $(this).closest('.form-group').removeClass('highlight-group');
        });
        
        // ØªØ£Ø«ÙŠØ± Ù†Ø¨Ø¶ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        setInterval(function() {
            $('.data-pulse').toggleClass('active');
        }, 1500);
    });
</script>
{% endblock %}